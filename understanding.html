

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Understanding pyqz &mdash; pyqz 0.7.2 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.7.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="pyqz 0.7.2 documentation" href="index.html" />
    <link rel="next" title="FAQ" href="faq.html" />
    <link rel="prev" title="Running pyqz" href="pyqz_demo/pyqz_demo.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="faq.html" title="FAQ"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="pyqz_demo/pyqz_demo.html" title="Running pyqz"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">pyqz 0.7.2 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="understanding-pyqz">
<span id="understandingpyqz"></span><h1>Understanding pyqz<a class="headerlink" href="#understanding-pyqz" title="Permalink to this headline">¶</a></h1>
<p>For a set of emission line fluxes and errors (from observed HII regions), <tt class="docutils literal"><span class="pre">pyqz</span></tt> measures the associated value of the oxygen abundance 12+log(O/H) and ionization parameters log(Q), given a set of MAPPINGS simulations of HII regions. The code uses <strong>flat(-ish)</strong> emission line diagnostic grids to disentangle and interpolate the values of log(Q) and 12+log(O/H).</p>
<p>As <tt class="docutils literal"><span class="pre">pyqz</span></tt> wraps around MAPPINGS simulations, it can provide estimates of the total abundance (<tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt>) or the gas-phase abundance of the HII region (<tt class="docutils literal"><span class="pre">gas[O]+12</span></tt>). In the reminder of this document, whenever the former is used, it is understood that it is replaceable by the latter.</p>
<p>If you have read this doc from the start, you probably have <tt class="docutils literal"><span class="pre">pyqz</span></tt> installed on your machine by now, and managed to run the basic examples described in <em class="xref std std-ref">runningpyqz</em>. But before you move on to process your own data, there are a few critical elements that you cannot ignore any longer.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">We&#8217;re serious here - read this page or be doomed !</p>
</div>
<div class="section" id="a-note-on-the-pyqz-syntax">
<h2>A note on the pyqz syntax<a class="headerlink" href="#a-note-on-the-pyqz-syntax" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">pyqz</span></tt> module is intimately linked to the MAPPINGS code. While both are stand alone and distinct programs, <tt class="docutils literal"><span class="pre">pyqz</span></tt> was designed to employ the same notation conventions than that of the MAPPINGS code for clarity, both from a user and programming perspective.</p>
<p>These conventions, designed to maximise clarity while minimizing the overall character counts, are as follows:</p>
<ul class="simple">
<li>the ionization parameter is <tt class="docutils literal"><span class="pre">LogQ</span></tt></li>
<li>the oxygen abundance is <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt> (total) or <tt class="docutils literal"><span class="pre">gas[O]+12</span></tt> (for the gas-phase)</li>
<li>the Balmer lines from Hydrogen are <tt class="docutils literal"><span class="pre">Ha</span></tt>, <tt class="docutils literal"><span class="pre">Hb</span></tt>, etc ...</li>
<li>forbidden lines are marked as <tt class="docutils literal"><span class="pre">[OIII]</span></tt>, <tt class="docutils literal"><span class="pre">[NII]</span></tt>, <tt class="docutils literal"><span class="pre">[SII]</span></tt>, <tt class="docutils literal"><span class="pre">[OI]</span></tt>, etc ...</li>
<li>for the usual strong line doublets, when the doublet line fluxes are considered together (i.e. [OIII]5007 + 4959), a <tt class="docutils literal"><span class="pre">+</span></tt> is appended to the said emission line, e.g. <tt class="docutils literal"><span class="pre">[OIII]+</span></tt>. By convention, the single line is always the strongest within the doublet. In short, <tt class="docutils literal"><span class="pre">[OIII]</span></tt> corresponds to [OIII]5007, <tt class="docutils literal"><span class="pre">[OIII]+</span></tt> corresponds to [OIII]5007+4959, <tt class="docutils literal"><span class="pre">[NII]</span></tt> corresponds to [NII]6584, <tt class="docutils literal"><span class="pre">[NII]+</span></tt> corresponds to [NII]6584+6548, etc ...</li>
</ul>
<p>This syntax must be followed carefully when using <tt class="docutils literal"><span class="pre">pyqz</span></tt>, or errors will arise.</p>
</div>
<div class="section" id="the-spirit-of-pyqz">
<h2>The spirit of <tt class="docutils literal"><span class="pre">pyqz</span></tt><a class="headerlink" href="#the-spirit-of-pyqz" title="Permalink to this headline">¶</a></h2>
<p>The pyqz module is composed of a core function: <tt class="docutils literal"><span class="pre">pyqz.interp_qz</span></tt>.
This function is responsible for interpolating the MAPPINGS IV grid of simulations of HII regions (using <tt class="docutils literal"><span class="pre">scipy.interpolate.griddata</span></tt>) and returns the corresponding value of z or q for a given pair of line ratios. This function is basic, in that it does not propagate errors on its own. You feed it a pair of line ratio, it returns <tt class="docutils literal"><span class="pre">LogQ</span></tt>, <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt> or <tt class="docutils literal"><span class="pre">gas[O]+12</span></tt>, and that&#8217;s it.</p>
<p>The function <tt class="docutils literal"><span class="pre">pyqz.get_global_qz</span></tt> is a wrapper around <tt class="docutils literal"><span class="pre">pyqz.interp_qz</span></tt>. It is designed as a top interaction layer for the pyqz module, and can propagate errors or upper-limits on the line flux measurements. You feed it your measured line fluxes and associated errors, and it returns all the <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt> or <tt class="docutils literal"><span class="pre">gas[O]+12</span></tt> estimates and associated errors.</p>
<p>Yep, that&#8217;s right: estimateS. What are these ?</p>
<div class="section" id="direct-estimates">
<h3>Direct estimates<a class="headerlink" href="#direct-estimates" title="Permalink to this headline">¶</a></h3>
<p>pyqz uses a well defined set of line ratio diagnostic grids (the list of which can be seen using <tt class="docutils literal"><span class="pre">pyqz.diagnostics.keys()</span></tt>) to interpolate <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt>. Given a set of line fluxes, pyqz can therefore compute 1 estimate of <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt> per diagnostic diagram chosen by the user, e.g. <tt class="docutils literal"><span class="pre">[NII]/[SII]+;[OIII]/[SII]+</span></tt>. These <strong>direct estimates</strong> (labelled with <tt class="docutils literal"><span class="pre">|LogQ</span></tt> and <tt class="docutils literal"><span class="pre">|Tot[O]+12</span></tt> for each diagnostic diagram, e.g. <tt class="docutils literal"><span class="pre">[NII]/[SII]+;[OIII]/[SII]+|LogQ</span></tt>) are the most straightforward ones computed by <tt class="docutils literal"><span class="pre">pyqz</span></tt>.</p>
<p>Of course, because all line ratio diagnostic grids are constructed from the same set of MAPPINGS simulations, all these individual direct estimates ought to be consistent, so that computing their mean value is a sensible thing to do. These <strong>averaged direct estimates</strong> are labelled <tt class="docutils literal"><span class="pre">&lt;LogQ&gt;</span></tt>, <tt class="docutils literal"><span class="pre">&lt;Tot[O]+12&gt;</span></tt>, etc ? and the associated standard deviations are labelled <tt class="docutils literal"><span class="pre">std(LogQ)</span></tt>, std(Tot[O]+12)``, etc ?</p>
</div>
<div class="section" id="kde-estimates">
<h3>KDE estimates<a class="headerlink" href="#kde-estimates" title="Permalink to this headline">¶</a></h3>
<p>As we do not leave in a perfect world, some errors are usually associated with the measurement of line fluxes. The direct estimates do not take any errors into account - the <strong>KDE estimates</strong> (KDE = Kernel Density Estimation) do.</p>
<p>The idea is as follows. First, a set of <tt class="docutils literal"><span class="pre">srs</span></tt> (where <tt class="docutils literal"><span class="pre">srs=400</span></tt> is the default) random flux values (for each emission line) sampling the probability density function of each measurement is generated. Each of these <tt class="docutils literal"><span class="pre">srs</span></tt> pseudo-sets of line fluxes are fed through <tt class="docutils literal"><span class="pre">pyqz.interp_qz()</span></tt>, which returns <tt class="docutils literal"><span class="pre">srs</span></tt> random estimates of <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt>. <tt class="docutils literal"><span class="pre">pyqz</span></tt> then uses a Kernel Density Estimation tool to reconstruct a) the probability density function (PDF) in the <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt> plane for every single diagnostic grid selected by the user, and b) the full probability density function in the <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt> plane resulting from the combination of all <tt class="docutils literal"><span class="pre">srs</span></tt> estimates for all chosen diagnostic grids. Python users have the ability to pickle these (individual and global) reconstructed PDFs for external use (via the <tt class="docutils literal"><span class="pre">KDE_save_PDFs</span></tt> keyword).</p>
<p>From the reconstructed probability density functions, pyqz computes the 0.61% (i.e. the 1-:math:sigma contour for a log normal distributions) level contour in the <tt class="docutils literal"><span class="pre">LogQ</span></tt> vs <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt> plane, with respect to the peak. <tt class="docutils literal"><span class="pre">pyqz</span></tt> subsequently returns as an (individual or global) KDE estimate the mean of the 0.61% contour and its associated half spatial extent along the <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt> directions.</p>
<p>These KDE estimates are referred to (accordingly) using <tt class="docutils literal"><span class="pre">|LogQ{KDE}</span></tt> and <tt class="docutils literal"><span class="pre">|Tot[O]+12{KDE}</span></tt> for the individual diagnostic grids (e.g. <tt class="docutils literal"><span class="pre">[NII]/[SII]+;[OIII]/[SII]+|LogQ{KDE}</span></tt> with an error <tt class="docutils literal"><span class="pre">err([NII]/[SII]+;[OIII]/[SII]+|LogQ{KDE})</span></tt>). The global KDE estimates are labelled as <tt class="docutils literal"><span class="pre">&lt;LogQ{KDE}&gt;</span></tt> and <tt class="docutils literal"><span class="pre">&lt;Tot[O]+12&gt;</span></tt>, with associated errors <tt class="docutils literal"><span class="pre">err(LogQ{KDE})</span></tt> and <tt class="docutils literal"><span class="pre">err(Tot[O]+12{KDE})</span></tt>.</p>
<p>At this point, things are most likely more confused than ever, and one may be wondering ...</p>
</div>
</div>
<div class="section" id="what-estimates-of-logq-and-tot-o-12-should-one-use">
<span id="estimates"></span><h2>What estimates of <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt> should one use ?<a class="headerlink" href="#what-estimates-of-logq-and-tot-o-12-should-one-use" title="Permalink to this headline">¶</a></h2>
<p>Unfortunately, there is no definite answer to this question. If all goes well (i.e. your measurements are reliable and have reasonable errors), the global KDE estimates (<tt class="docutils literal"><span class="pre">&lt;LogQ{KDE}&gt;</span></tt> and <tt class="docutils literal"><span class="pre">&lt;Tot[O]+12&gt;</span></tt>) are the values one should use: these combine all requested diagnostic grids estimates and observational errors down to one number.</p>
<p>But many things can go wrong: one (or more) of your line fluxes might be unknowingly off, or perhaps the choice of MAPPINGS simulations is not quite appropriate for the HII regions one may be working with (in terms of pressure, abundances, structure, depletion, etc ?), or perhaps real HII regions may simply not behave quite like MAPPINGS is predicting (sigh!). <strong>In all those cases, one must use extreme caution with the global KDE estimates.</strong> A lot of information lies in the individual estimates of <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt>, and especially in bad cases.</p>
<p>So, how does one identify the <em>good</em> cases from the <em>bad</em> cases ?</p>
<dl class="docutils">
<dt>Comparing the averaged direct estimates (e.g. <tt class="docutils literal"><span class="pre">&lt;LogQ&gt;</span></tt>) with the global KDE estimates (e.g. <tt class="docutils literal"><span class="pre">&lt;LogQ{KDE}&gt;</span></tt>) is a good way to spot problem. For each set of line ratios fed to <tt class="docutils literal"><span class="pre">pyqz.get_global_qz()</span></tt>, the code checks how similar those estimates are, and issues a flag if they are not. The possible flag values are as follows:</dt>
<dd><ul class="first last simple">
<li>&#8216;9&#8217;: the PDF is multipeaked. This indicates a likely mismatch between some of the diagnostic grids in their estimates of <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt>.</li>
<li>&#8216;8&#8217;: the observed set of line fluxes is located outside the valid region of one or more of the chosen diagnostic grids.</li>
<li>&#8216;-1&#8217;: no KDE was computed (either <tt class="docutils literal"><span class="pre">srs</span></tt> was set to 0, or a line flux errors was set to 0).</li>
<li>&#8216;1-4&#8217;: these flags are raised when the averaged direct estimates are offset by more than <tt class="docutils literal"><span class="pre">flag_level</span></tt> times their standard deviations, e.g.:
* &#8216;1&#8217; &lt;-&gt; <tt class="docutils literal"><span class="pre">|&lt;LogQ&gt;</span> <span class="pre">-</span> <span class="pre">&lt;LogQ{KDE}&gt;|&lt;</span> <span class="pre">std(LogQ)*flag_level</span></tt>
* &#8216;2&#8217; &lt;-&gt; <tt class="docutils literal"><span class="pre">|&lt;LogQ&gt;</span> <span class="pre">-</span> <span class="pre">&lt;LogQ{KDE}&gt;|&lt;</span> <span class="pre">err(LogQ{KDE})*flag_level</span></tt>
* &#8216;3&#8217; &lt;-&gt; <tt class="docutils literal"><span class="pre">|&lt;Tot[O]+12&gt;</span> <span class="pre">-</span> <span class="pre">&lt;Tot[O]+12{KDE}&gt;|&lt;</span> <span class="pre">std(Tot[O]+12)*flag_level</span></tt>
* &#8216;4&#8217; &lt;-&gt; <tt class="docutils literal"><span class="pre">|&lt;Tot[O]+12&gt;</span> <span class="pre">-</span> <span class="pre">&lt;Tot[O]+12{KDE}&gt;|&lt;</span> <span class="pre">err(Tot[O]+12{KDE})*flag_level</span></tt></li>
</ul>
</dd>
</dl>
<p>Looking at the flags can be helpful in identifying potentially problematic sets of line fluxes and (maybe?) the cause. Is one diagnostic grid estimates consistently ? Then maybe some errors in one of the line ratio measurements is not properly accounted for.</p>
<p>In the end, it remains to the user to decide which estimate(s) to use. The final choice will significantly depend on the intended usage, the importance given to the <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt> estimates in a subsequent analysis, and the ability to construct a precise model of the said HII region in the first place.</p>
<p><strong>It cannot be stressed enough that choosing appropriate HII regions parameters (in terms of pressure, spatial structure, abundances, etc ?) for the MAPPINGS simulations can and will influence the final estimates of ``LogQ`` and ``Tot[O]+12``, both individual and global ones</strong>. If you are using <tt class="docutils literal"><span class="pre">pyqz</span></tt>, chances are that you do not possess enough information to define these elements with certainty, and simply use the default diagnostic grids provided. This is fine. But in case of estimates mismatch, one must then keep this fact in mind.</p>
</div>
<div class="section" id="some-pyqz-parameters-of-particular-interest">
<h2>Some pyqz parameters of particular interest<a class="headerlink" href="#some-pyqz-parameters-of-particular-interest" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>srs</strong>: the &#8216;size of the random sample&#8217; of line fluxes generated by pyqz. This is used to propagate the probability density function associated with each line flux measurements. In other words, this is the number of discrete estimates of the probability density function (in the <tt class="docutils literal"><span class="pre">LogQ</span> <span class="pre">-</span> <span class="pre">Tot[O]+12</span></tt> plane) associated with one diagnostic grid. Hence, the joint probability function density function (combining N diagnostic grids) will be reconstructed via a Kernel Density Estimation routine from N x srs points. <tt class="docutils literal"><span class="pre">srs=400</span></tt> is the default value, and we suggest a <tt class="docutils literal"><span class="pre">srs=1000</span></tt> for errors at the 10%-15% level. Larger errors result in wider probability density peaks, and require more <tt class="docutils literal"><span class="pre">srs</span></tt> points to be properly discretized - at the cost of additional computation time of course  ?</li>
<li><strong>KDE_method</strong>: the Kernel Density Estimation routine used to reconstruct the individual and joint probability density functions in the <tt class="docutils literal"><span class="pre">LogQ</span> <span class="pre">-</span> <span class="pre">Tot[O]+12</span></tt> plane. Either <tt class="docutils literal"><span class="pre">gauss</span></tt> to use <tt class="docutils literal"><span class="pre">gaussian_kde</span></tt> from the <tt class="docutils literal"><span class="pre">scipy.stats</span></tt> module, or <tt class="docutils literal"><span class="pre">multiv</span></tt> to use <tt class="docutils literal"><span class="pre">KDEMultivariate</span></tt> from the <tt class="docutils literal"><span class="pre">statsmodels</span></tt> package. The former choice is 10-100x faster, but usually results in less accurate results if different diagnostics grid diagree. The underlying reason is that with <tt class="docutils literal"><span class="pre">gaussian_kde</span></tt>, the kernel bandwidth cannot be explicitly set individually for the <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt> directions, so that the function tends to over-smooth the distribution. <tt class="docutils literal"><span class="pre">KDEMultivariate</span></tt> should be preferred as the bandwidth of the kernel is set individually for both the <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt> directions using Scott&#8217;s rule, scaled by the standard deviation of the distribution along these directions.</li>
<li><strong>KDE_qz_sampling</strong>: the sampling of the <tt class="docutils literal"><span class="pre">LogQ</span></tt> and <tt class="docutils literal"><span class="pre">Tot[O]+12</span></tt> plane, when reconstructing the individual and gloabl PDF. Set to <tt class="docutils literal"><span class="pre">101j</span></tt> by default (i.e. a grid with 101x101 = 10201 sampling nodes), datasets with small errors (&lt;10%) might require twice this resolution for better results (i.e. <tt class="docutils literal"><span class="pre">KDE_qz_sampling=201j</span></tt>).</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installing pyqz</a></li>
<li class="toctree-l1"><a class="reference internal" href="pyqz_demo/pyqz_demo.html">Running pyqz</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Understanding pyqz</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="functions.html">The functions of pyqz</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="pyqz_demo/pyqz_demo.html"
                        title="previous chapter">Running pyqz</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="faq.html"
                        title="next chapter">FAQ</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="faq.html" title="FAQ"
             >next</a> |</li>
        <li class="right" >
          <a href="pyqz_demo/pyqz_demo.html" title="Running pyqz"
             >previous</a> |</li>
        <li><a href="index.html">pyqz 0.7.2 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Frédéric Vogt.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>